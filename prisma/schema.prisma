// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}


// ================================
// AUTHENTICATION & ADMIN MODELS
// ================================

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("admin")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auditLogs    AuditLog[]
  contactReplies ContactReply[]

  @@map("admin_users")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // CREATE, UPDATE, DELETE, BULK_DELETE, BULK_UPDATE, REPLY, etc.
  resource   String   // contacts, skills, projects, etc.
  resourceId String?
  oldData    String?  @db.Text
  newData    String?  @db.Text
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  user AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

/// Analytics sessions and events for privacy-first tracking
model AnalyticsSession {
  id         String   @id @default(cuid())
  startedAt  DateTime @default(now())
  lastSeenAt DateTime @updatedAt
  country    String?
  city       String?
  referrer   String?
  utmSource  String?
  utmMedium  String?
  utmCampaign String?
  device     String?
  userAgent  String?
  hashedIp   String?

  events     AnalyticsEvent[]

  @@index([startedAt])
  @@index([utmSource, utmCampaign])
  @@map("analytics_sessions")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  sessionId  String
  type       String
  page       String?
  ctaId      String?
  scrollPct  Int?
  durationMs Int?
  meta       Json?
  createdAt  DateTime @default(now())

  session    AnalyticsSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([page])
  @@index([createdAt])
  @@map("analytics_events")
}

model AnalyticsRollup {
  id        String   @id @default(cuid())
  date      DateTime
  metric    String   // e.g., sessions, pageviews, bounce_rate, ctr
  label     String?  // page path, UTM source, CTA id, etc.
  value     Float
  createdAt DateTime @default(now())

  @@index([date, metric])
  @@map("analytics_rollups")
}

// ================================
// PERSONAL INFORMATION
// ================================

model PersonalInfo {
  id          String   @id @default("default")
  fullName    String
  title       String
  bio         String?  @db.Text
  email       String
  phone       String?
  location    String?
  website     String?
  githubUsername String?
  avatar      String?
  resume      String?
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("personal_info")
}

// ================================
// SKILLS & EXPERTISE
// ================================

model Skill {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?  @db.Text
  category     String   // language, frontend, backend, database, devops, design, etc.
  level        Int      @default(0) // 0-100
  color        String?  // Hex color for UI
  logo         String?  // URL to skill logo/icon
  experience   Int?     // Years of experience
  projects     String?  @db.Text // JSON array of project names
  strengths    String?  @db.Text // JSON array of specific strengths
  isVisible    Boolean  @default(true)
  isFeatured   Boolean  @default(false)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([isVisible])
  @@index([displayOrder])
  @@map("skills")
}

// ================================
// PROJECTS & PORTFOLIO
// ================================

model Project {
  id              String   @id @default(cuid())
  title           String
  description     String   @db.Text
  longDescription String?  @db.Text
  category        String   @default("Other") // web-app, mobile-app, api, library, etc.
  techStack       String[] // Native PostgreSQL array
  status          ProjectStatus @default(draft)
  featured        Boolean  @default(false)
  repoUrl         String?  // Renamed from githubUrl
  projectUrl      String?  // Renamed from liveUrl
  imageUrl        String?
  gallery         String?  @db.Text // JSON array of image URLs
  highlights      String?  @db.Text // JSON array of key features
  challenges      String?  @db.Text // JSON array of technical challenges
  learnings       String?  @db.Text // JSON array of key learnings
  startDate       DateTime?
  endDate         DateTime?
  teamSize        Int?
  role            String?  // Lead Developer, Full Stack Developer, etc.
  isVisible       Boolean  @default(true)
  displayOrder    Int      @default(0)
  viewCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([featured])
  @@index([category])
  @@index([isVisible])
  @@index([displayOrder])
  @@map("projects")
}

enum ProjectStatus {
  draft
  published
  archived
}

// ================================
// WORK EXPERIENCE
// ================================

model WorkExperience {
  id           String    @id @default(cuid())
  company      String
  position     String
  startDate    DateTime
  endDate      DateTime?
  description  String?   @db.Text
  achievements String?   @db.Text // JSON array
  technologies String?   @db.Text // JSON array
  companyLogo  String?
  companyUrl   String?
  location     String?
  employmentType String? // Full-time, Part-time, Contract, Freelance
  isVisible    Boolean   @default(true)
  displayOrder Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([isVisible])
  @@index([displayOrder])
  @@map("work_experience")
}

// ================================
// EDUCATION
// ================================

model Education {
  id           String    @id @default(cuid())
  institution  String
  degree       String
  fieldOfStudy String?
  startDate    DateTime
  endDate      DateTime?
  gpa          String?
  honors       String?
  description  String?   @db.Text
  activities   String?   @db.Text // JSON array
  isVisible    Boolean   @default(true)
  displayOrder Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([isVisible])
  @@index([displayOrder])
  @@map("education")
}

// ================================
// CERTIFICATIONS & ACHIEVEMENTS
// ================================

model Certification {
  id           String    @id @default(cuid())
  name         String
  issuer       String
  issueDate    DateTime
  expiryDate   DateTime?
  credentialId String?
  credentialUrl String?
  description  String?   @db.Text
  skills       String?   @db.Text // JSON array
  isVisible    Boolean   @default(true)
  displayOrder Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([isVisible])
  @@index([displayOrder])
  @@map("certifications")
}

model Achievement {
  id           String   @id @default(cuid())
  title        String
  description  String   @db.Text
  category     String   // award, recognition, milestone, etc.
  date         DateTime
  issuer       String?
  url          String?
  imageUrl     String?
  isVisible    Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([isVisible])
  @@index([displayOrder])
  @@map("achievements")
}

// ================================
// CONTACT & COMMUNICATION
// ================================

model Contact {
  id        String        @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String        @db.Text
  phone     String?
  company   String?
  status    ContactStatus @default(pending)
  priority  ContactPriority @default(normal)
  source    String?       // website, linkedin, referral, etc.
  tags      String?       @db.Text // JSON array
  notes     String?       @db.Text
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  replies ContactReply[]

  // New "Hire Me" Fields
  inquiryType    InquiryType @default(GENERAL)
  projectDetails String?     @db.Text // JSON from Configurator
  budget         String?
  salary         String?
  metadata       String?     @db.Text // JSON

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("contacts")
}

enum InquiryType {
  GENERAL
  PROJECT
  JOB
}

enum ContactStatus {
  pending
  responded
  archived
  spam
}

enum ContactPriority {
  low
  normal
  high
  urgent
}

model ContactReply {
  id            String   @id @default(cuid())
  contactId     String
  userId        String
  subject       String
  message       String   @db.Text
  isAiGenerated Boolean  @default(false)
  aiMode        String?  // auto-generate, enhance-draft, manual
  emailSent     Boolean  @default(false)
  createdAt     DateTime @default(now())

  // Relations
  contact Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user    AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([userId])
  @@map("contact_replies")
}

// ================================
// SOCIAL LINKS & PROFILES
// ================================

model SocialLink {
  id           String   @id @default(cuid())
  platform     String   // github, linkedin, twitter, instagram, etc.
  url          String
  username     String?
  isVisible    Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([platform])
  @@index([isVisible])
  @@index([displayOrder])
  @@map("social_links")
}

// ================================
// MEDIA & ASSETS
// ================================

model Media {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  alt          String?
  category     String?  // avatar, project, gallery, document, etc.
  tags         String?  @db.Text // JSON array
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
  @@map("media")
}

// ================================
// FAQ & SUPPORT
// ================================

model FAQ {
  id           String   @id @default(cuid())
  question     String
  answer       String   @db.Text
  category     String
  tags         String?  @db.Text // JSON array
  isVisible    Boolean  @default(true)
  viewCount    Int      @default(0)
  helpful      Int      @default(0)
  notHelpful   Int      @default(0)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([isVisible])
  @@index([displayOrder])
  @@map("faqs")
}

// ================================
// GITHUB STATS CACHE
// ================================

model GithubStats {
  id        String   @id @default(cuid())
  username  String   @unique
  data      Json     // Store the full stats object
  fetchedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("github_stats")
}

model ChatCheckpoint {
  thread_id         String
  checkpoint_ns     String
  checkpoint_id     String
  parent_checkpoint_id String?
  type              String?
  checkpoint        Json
  metadata          Json
  
  @@id([thread_id, checkpoint_ns, checkpoint_id])
  @@map("chat_checkpoints")
}

model KnowledgeSnippet {
  id        String   @id @default(cuid())
  content   String   @db.Text
  source    String?  // e.g. "manual", "resume", "project-1"
  tags      String?  @db.Text // JSON array
  isVisible Boolean  @default(true)
  metadata  Json?    // Flexible metadata for vector store
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("knowledge_snippets")
}

model ChatWrite {
  thread_id         String
  checkpoint_ns     String
  checkpoint_id     String
  task_id           String
  idx               Int
  channel           String
  type              String?
  blob              String?
  value             Json?

  @@id([thread_id, checkpoint_ns, checkpoint_id, task_id, idx])
  @@map("chat_writes")
}
model Resume {
  id        String   @id @default(cuid())
  title     String
  latex     String   @db.Text
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("resumes")
}

// ================================
// JOB DISCOVERY & APPLICATIONS
// ================================

model JobSource {
  id        String   @id @default(cuid())
  name      String
  url       String?
  kind      String   // linkedin, wellfound, yc, careers, github, twitter, custom
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads JobLead[]

  @@map("job_sources")
}

model JobLead {
  id           String    @id @default(cuid())
  sourceId     String
  title        String
  company      String
  location     String?
  url          String?
  description  String?   @db.Text
  tags         String?   @db.Text
  seniority    String?
  remote       Boolean   @default(false)
  salary       String?
  postedAt     DateTime?
  status       String    @default("new") // new, shortlisted, rejected, applied
  matchScore   Float?
  missingSkills String?  @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  source JobSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  enrichments LeadEnrichment[]
  applications Application[]

  @@index([sourceId])
  @@index([status])
  @@map("job_leads")
}

model LeadEnrichment {
  id        String   @id @default(cuid())
  leadId    String
  kind      String   // jd_parse, osint, recruiter_lookup
  data      Json
  createdAt DateTime @default(now())

  lead JobLead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("lead_enrichments")
}

model RecruiterContact {
  id        String   @id @default(cuid())
  name      String?
  email     String?
  company   String?
  role      String?
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications Application[]

  @@index([company])
  @@map("recruiter_contacts")
}

model Application {
  id          String    @id @default(cuid())
  leadId      String
  recruiterId String?
  status      String    @default("queued") // queued, sent, replied, interview, rejected, accepted
  cvVersionId String?
  sentAt      DateTime?
  followupAt  DateTime?
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lead      JobLead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  recruiter RecruiterContact @relation(fields: [recruiterId], references: [id])
  events    ApplicationEvent[]

  @@index([leadId])
  @@index([status])
  @@map("applications")
}

model ApplicationEvent {
  id            String   @id @default(cuid())
  applicationId String
  type          String   // submitted, followup_sent, reply_positive, reply_negative, bounced
  payload       Json?
  createdAt     DateTime @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([type])
  @@map("application_events")
}

model EmailCampaign {
  id          String   @id @default(cuid())
  name        String
  templateId  String?
  fromAddress String?
  warmupScore Float?
  status      String   @default("draft") // draft, running, paused
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events EmailEvent[]

  @@map("email_campaigns")
}

model EmailEvent {
  id          String   @id @default(cuid())
  campaignId  String?
  applicationId String?
  toAddress   String?
  type        String   // sent, open, reply, bounce, spam, delivered
  metadata    Json?
  createdAt   DateTime @default(now())

  campaign    EmailCampaign? @relation(fields: [campaignId], references: [id])
  application Application?   @relation(fields: [applicationId], references: [id])

  @@index([campaignId])
  @@index([applicationId])
  @@index([type])
  @@map("email_events")
}
